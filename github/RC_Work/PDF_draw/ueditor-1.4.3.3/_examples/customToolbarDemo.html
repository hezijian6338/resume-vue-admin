<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title></title>
    <script type="text/javascript" charset="utf-8" src="../ueditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="editor_api.js"></script>
    <style type="text/css">
        #editor {
            border: 1px solid #CCC;
            width: 1000px
        }
        #editor_toolbar_box {
            background: #F0F0EE;
            padding: 2px;
        }
        #editor_iframe_holder {
            border-top: 1px solid #CCC;
            border-bottom: 1px solid #CCC;
        }
    </style>
</head>
<body>
<h1>UEditor自定义toolbar</h1>
    <div id="editor">
        <div id="editor_toolbar_box">
            <div id="editor_toolbar">
                <input id="bold" type="button" value="加粗" onclick="myeditor.execCommand('bold')" style="height:24px;line-height:20px"/>
                <input id="italic" type="button" value="加斜" onclick="myeditor.execCommand('italic')" style="height:24px;line-height:20px"/>
                <select id="fontfamily" onchange="myeditor.execCommand('fontfamily',this.value)">
                    <option value="宋体,simsun">宋体</option>
                    <option value="楷体,楷体_gb2312,simkai">楷体</option>
                    <option value="隶书,simli">隶书</option>
                    <option value="黑体,simhei">黑体</option>
                    <option value="andale mono,times">andale mono</option>
                    <option value="arial,helvetica,sans-serif">arial</option>
                    <option value="arial black,avant garde">arial black</option>
                    <option value="comic sans ms,sans-serif">comic sans ms</option>
                </select>
                <select id="fontsize" onchange="myeditor.execCommand('fontsize',this.value)">
                    <option value="10pt">10pt</option>
                    <option value="11pt">11pt</option>
                    <option value="12pt">12pt</option>
                    <option value="14pt">14pt</option>
                    <option value="16pt">16pt</option>
                    <option value="18pt">18pt</option>
                    <option value="20pt">20pt</option>
                    <option value="22pt">22pt</option>
                    <option value="24pt">24pt</option>
                    <option value="36pt">36pt</option>
                </select>
                <input type="button" value="插入html" onclick="insert()" style="height:24px;line-height:20px"/>
                <input type="button" value="清除格式" onclick="myeditor.execCommand('removeformat')" style="height:24px;line-height:20px"/>
                <input type="button" value="获得编辑器内容" onclick="alert(myeditor.getContent())" style="height:24px;line-height:20px"/>
                <input type="button" value="获得编辑器纯文本内容" onclick="alert(myeditor.getContentTxt())" style="height:24px;line-height:20px"/>
            </div>
        </div>

        <!--测试代码-->
        <table>
            <tr>
                <td class="first">
                    <ul id="components"></ul>
                </td>
                <td>
                    <div id="container">
                    </div>
                </td>
                <td style="vertical-align:top;">
                    <label for="txtname">名称:</label><input id="txtname" name="txtname" type="text" />
                    <br />
                    <label for="txtdes">说明:</label><input id="txtdes" name="txtdes" type="text" />
                </td>
            </tr>
        </table>
        <div id="editor_iframe_holder" ></div>
    </div>

    <!--测试代码-->
<script type="text/javascript" src="jmgraph.debug.js"></script>
<script type="text/javascript" src="images.js" ></script>

<script type="text/javascript" charset="utf-8" >
        function $G(id){
            return document.getElementById(id);
        }
        //实例化一个不带ui的编辑器,注意此处的实例化对象是baidu.editor下的Editor，而非baidu.editor.ui下的Editor
        var myeditor = UE.getEditor('editor_iframe_holder',{
            toolbars:[[]],
            initialContent: '初始化内容',//初始化编辑器的内容
            initialFrameHeight: 200
        });
        //给编辑器增加一个选中改变的事件，用来判断所选内容以及状态
        myeditor.addListener('selectionchange', function (){
            var cmdName = ['bold','italic'],//命令列表
                fontName = ['fontfamily','fontsize'];//字体设置下拉框列表，此处选择其中两个

            //查询每个命令当前的状态，并设置对应状态样式
            var i =-1;
            while(i++ < cmdName.length-1){
                var state = myeditor.queryCommandState(cmdName[i]);
                $G(cmdName[i]).style.color = state == 1?"red":"";
            }
            //依据当前光标所在的字体改变下拉列表的选中值
            i = -1;
            while(i++<fontName.length-1){
                var fstate = myeditor.queryCommandValue(fontName[i]).toLowerCase();
                var fselect = $G(fontName[i]);
                for(var j= 0;j<fselect.options.length;j++){
                    if(fselect.options[j].value.toLowerCase().indexOf(fstate.split(",")[0])!=-1){
                        fselect.options[j].selected = "true";
                    }
                }
            }
        });
        //插入文本
        function insert(){
            var insertTxt = "插入的文本";
            insertTxt = prompt("插入的内容",insertTxt);
            insertTxt&&myeditor.execCommand("inserthtml",insertTxt);
        }
        function execUnderline(cmd){
            myeditor.execCommand(cmd);
        }

        //添加测试代码（HZJ）




        //初始化编辑器
        var editor = new jmEditor({
            container:'container',
            width:800,
            height:600,
            enabled : true,//可以编辑
            connectable:true,//可以连线
            movable:true,//可以移动元素
            resizable:true//可以改变元素大小
        });


        var style = {
            stroke:'#000',
            //fill : bg,//指定默认背景为渐变
            lineWidth:1,
            close:true,
            lineJoin:'round',
            radius:6,
            resizable : true,//默认元素可以放大缩小
            zIndex:1000
        };

        //设定边框样式，用于放大缩小拖放框
        style.borderStyle = {
            stroke:'#000',
            //fill:'transparent',
            rectStroke:'#3BDB05',//放大缩小小方块颜色
            close:true
        };


        //字体样式
        style.fontStyle = {
            fill:'blue',
            textAlign:'center',
            textBaseline:'middle',//垂直居中
            font:'14px 微软雅黑'
        };

        //状态小图标样式
        style.overlay = {
            margin:{
                left:10,
                top:10
            }
        };

        //指定为文本框
        style.shape = 'rect';
        editor.regStyle('text_Edit',style);
        //复制一个进程选择样式
        var processselectedstyle = jmUtils.clone(style);
        //注册选择状态
        //processselectedstyle.fill = 'red';
        editor.regStyle('text_Edit_selected',processselectedstyle);

//
//        //指定条件图形为一个"文本框"
//        style = jmUtils.clone(style);
//        style.shape = 'rect';
//        editor.regStyle('Text',style);
//        //没有改变选中状态样式
//        editor.regStyle('Text_selected',style);
//
//        //指定fork元素为方块。背景为:#000
//        style = jmUtils.clone(style);
//        style.fill = '#000';
//        style.resizable = false;//锁定其不让改变大小
//        style.shape = 'rect';
//        editor.regStyle('fork',style);
//        editor.regStyle('fork_selected',style);
//
//
//        //指定join为一个椭圆,样式续承自fork
//        style = jmUtils.clone(style);
//        style.shape = 'arc';
//        editor.regStyle('join',style);
//        editor.regStyle('join_selected',style);
//
//        //指定子流程为方块。背景为90EE90,可以改变大小
//        style = jmUtils.clone(style);
//        style.fill = '#90EE90';
//        //style.stroke = 'rgb(248,195,60)';
//        style.resizable = true;
//        style.shape = 'rect';
//        editor.regStyle('subflow',style);
//        editor.regStyle('subflow_selected',style);
//
//        //上传文件样式为一张图片
//        style = jmUtils.clone(style);
//        style.resizable = true;
//        style.shape = 'img';
//        style.width = 120;
//        style.height = 80;
//        style.image = images.upload;
//        editor.regStyle('upload', style);
//        editor.regStyle('upload-selected', style);
//
//
//        //下载文件
//        style = jmUtils.clone(style);
//        style.image = images.process;
//        editor.regStyle('download', style);
//        editor.regStyle('download-selected', style);
//
//        //开始样式,不可改变大小，背景透明
//        var startstyle = jmUtils.clone(style);
//        //startstyle.fill = 'transparent';
//        startstyle.resizable = false;
//        startstyle.shape = 'arc';
//        editor.regStyle('start',startstyle);
//        editor.regStyle('start_selected',startstyle);
//
        //结束样式
        var endstyle = jmUtils.clone(style);
        endstyle.shape = 'rect';
        editor.regStyle('end',endstyle);
        editor.regStyle('end_selected',endstyle);

//
//
//


        //编辑器组件
        var components = document.getElementById('components');

        var startimg = editor.regComponent(images.start,{width:60,height:60,style:'text_Edit',value:'文本框'});
        var li = document.createElement('li');
        li.appendChild(startimg);
        components.appendChild(li);

//        var processimg = editor.regComponent(images.process,{width:100,height:80,style:'process',value:'process'});
//        li = document.createElement('li');
//        li.appendChild(processimg);
//        components.appendChild(li);
//
//        var subflowimg = editor.regComponent(images.subflow,{width:100,height:80,style:'subflow'});
//        li = document.createElement('li');
//        li.appendChild(subflowimg);
//        components.appendChild(li);
//
//        var forkimg = editor.regComponent(images.fork,{width:100,height:40,style:'fork'});
//        li = document.createElement('li');
//        li.appendChild(forkimg);
//        components.appendChild(li);
//
//        var joinimg = editor.regComponent(images.join,{width:100,height:50,style:'join'});
//        li = document.createElement('li');
//        li.appendChild(joinimg);
//        components.appendChild(li);
//
//        var switchimg = editor.regComponent(images['switch'],{width:100,height:50,style:'switch'});
//        li = document.createElement('li');
//        li.appendChild(switchimg);
//        components.appendChild(li);

//        var upimg = editor.regComponent(images['upload'],{width:100,height:50,style:'upload'});
//        li = document.createElement('li');
//        li.appendChild(upimg);
//        components.appendChild(li);
//
//        var downimg = editor.regComponent(images['download'],{width:100,height:50,style:'download'});
//        li = document.createElement('li');
//        li.appendChild(downimg);
//        components.appendChild(li);

        var endimg = editor.regComponent(images.end,{width:60,height:60,style:'end',value:'结束'});
        li = document.createElement('li');
        li.appendChild(endimg);
        components.appendChild(li);


        //手动创建节点
//        var startcell = editor.addCell({position :{x:20,y:30},width:60,height:60,style:'start',value:'开始'});
//        var cell1 = editor.addCell({position :{x:80,y:120},width:100,height:60,style:'process'});
//        cell1.value('test cell');
//        editor.graph.refresh();



        //元素上的右健菜单
        editor.graph.bind('mouseup',function(evt) {
            var menus = editor.menus();
            //如果右击在元素上
            if(evt.button == 2 && evt.target && evt.target.findParent) {
                ////右击在元素上或其子元素上,向上查询其父容器jmcell
                var cell = evt.target.type == 'jmCell' ?evt.target: evt.target.findParent('jmCell');
                if(cell) {
                    menus.add('属性',function() {
                        alert(1);
                    }).show();
                    return false;
                }
                //击中空白处
                else {
                    menus.add('属性',function() {
                        alert(1);
                    }).show();
                    return false;//阻断冒泡
                }
            }
            menus.hide();
        });

        //监听选择事件
        editor.on('select',function(cell,selected) {
            if(cell.is('jmCell')) {
                //当元素被选择后，更改其样式
                var stylename = cell.styleName;
                var _index = stylename.indexOf('_');
                if(_index > 0) {
                    stylename = stylename.substring(0,_index);
                }
                cell.setStyle(selected?stylename + '_selected':stylename);

                if(selected) {
                    var cells = editor.getSelectedCells();//获取所有选择的元素
                    //如果只选中一个
                    if(cells.length == 1) {
                        document.getElementById('txtname').value = cell.value();
                    }
                }
            }
            else if(cell.is(jmConnectLine)) {
                if(selected) {
                    var cns = editor.getSelectedConnects();//获取所有选择的连线
                    //如果只选中一个
                    if(cns.length == 1) {
                        document.getElementById('txtname').value = cell.value();
                    }
                }
            }
        });


        //检查元素是否可以添加
        editor.validCell = function(cell) {
            var cells = this.getCells();
            for(var i=0;i< cells.length;i++) {
                var c = cells[i];
                if(cell.styleName == 'start' && c.styleName == 'start') {
                    alert('开始元素有且只能有一个');
                    return false;
                }
                else if(cell.styleName == 'end' && c.styleName == 'end') {
                    alert('结束元素有且只能有一个');
                    return false;
                }
            }
            return true;
        };
        //检查元素是否可以相连
        editor.validConnect = function(from,to) {
            if(from.styleName == 'start') {
                if(from.connects.count() > 0) {
                    alert('开始元素有且只能有一个出口');
                    return false;
                }
            }
            else if(from.styleName == 'join') {
                //如果fork已存在出口
                if(from.connects.count(function(con) {
                        return con.from = from;
                    }) > 0) {
                    alert('join元素有且只能有一个出口');
                    return false;
                }
            }
            return true;
        };

        //绑定名称改变事件，将值绑定到被选 中的元素上
        jmUtils.bindEvent(document.getElementById('txtname'),'change',function() {
            var cells = editor.getSelectedCells();//获取所有选择的元素
            for(var i in cells) {
                cells[i].value(this.value);
            }
            var cns = editor.getSelectedConnects();
            for(var i in cns) {
                cns[i].value(this.value);
            }
            editor.graph.refresh();//刷新画布
        });
        //------------------测试代码结束--------------
    </script>
</body>
</html>

<!--测试代码-->
<style>
    table td.first {
        width:150px;
        vertical-align:top;
        background-color: #ccc;
    }
    #components {
        list-style: none;
        padding:0;
        margin: 0;
    }
    #components li img {
        max-height:22px;
    }

    div.editor-menu ul {
        list-style: none;
        padding:0;
        margin:0;
    }
    div.editor-menu ul li {
        cursor:pointer;
        color:blue;
        padding: 2px;
    }
    div.editor-menu ul li:hover {
        color:green;
        background-color: #ccc;
    }
</style>
